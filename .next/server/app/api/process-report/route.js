(()=>{var a={};a.id=6576,a.ids=[6576],a.modules={87:(a,b,c)=>{"use strict";c.d(b,{E2:()=>g,Vt:()=>h});var d=c(82461);let e="https://yhtnlxnntpipnshtivqx.supabase.co",f=process.env.SUPABASE_SERVICE_ROLE_KEY;(0,d.UU)(e,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlodG5seG5udHBpcG5zaHRpdnF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzQxNDksImV4cCI6MjA3MTkxMDE0OX0.MdE9PWSWFFLMcudTw40lehT2HXiG-S6S4gfWfod0mVM",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},db:{schema:"public"},global:{headers:{"x-my-custom-header":"FarmaGenius"}}});let g=f?(0,d.UU)(e,f,{auth:{autoRefreshToken:!1,persistSession:!1},db:{schema:"public"}}):null;function h(){return{url:e,hasServiceRole:!!f,projectId:e.match(/https:\/\/([^.]+)\./)?.[1]||"unknown"}}},261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{"use strict";a.exports=require("querystring")},11997:a=>{"use strict";a.exports=require("punycode")},12412:a=>{"use strict";a.exports=require("assert")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},22931:(a,b,c)=>{"use strict";c.d(b,{Hv:()=>h});let d=[{value:"CAPSULAS PRONTAS",label:"C\xe1psulas Prontas",group:"S\xd3LIDOS"},{value:"CAPSULAS",label:"C\xe1psulas",group:"S\xd3LIDOS"},{value:"CAPSULAS GASTRO",label:"C\xe1psulas Gastro",group:"S\xd3LIDOS"},{value:"SACHES",label:"Sach\xeas",group:"S\xd3LIDOS"},{value:"MATERIA PRIMA",label:"Mat\xe9ria Prima",group:"S\xd3LIDOS"},{value:"GEL TRANSDERMICO, GEL VAGINAL",label:"Gel Transd\xe9rmico/Vaginal",group:"DERMATO A"},{value:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",label:"Cremes e Lo\xe7\xf5es",group:"DERMATO A"},{value:"BASE SERUM",label:"Base Serum",group:"DERMATO A"},{value:"SHOT",label:"Shot",group:"DERMATO A"},{value:"SOLU\xc7\xc3O, XAROPE, ESMALTE",label:"Solu\xe7\xe3o/Xarope/Esmalte",group:"DERMATO A"},{value:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",label:"Produtos Capilares",group:"DERMATO A"},{value:"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA",label:"Lo\xe7\xe3o Capilar",group:"DERMATO A"},{value:"GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL",label:"G\xe9is Diversos",group:"DERMATO A"},{value:"GEL COMESTIVEL",label:"Gel Comest\xedvel",group:"DERMATO A"},{value:"LIQUID CAPS",label:"Liquid Caps",group:"DERMATO C"},{value:"CAPSULAS VAGINAIS",label:"C\xe1psulas Vaginais",group:"DERMATO C"},{value:"GOMAS",label:"Gomas",group:"DERMATO C"},{value:"PASTILHAS",label:"Pastilhas",group:"DERMATO C"},{value:"BOMBOM",label:"Bombom",group:"DERMATO C"},{value:"FILMES",label:"Filmes",group:"DERMATO C"},{value:"OVULOS",label:"\xd3vulos",group:"DERMATO C"},{value:"FILME VAGINAL",label:"Filme Vaginal",group:"DERMATO C"},{value:"HOMEOPATIA, FLORAL E VEICULO",label:"Homeopatia/Floral/Ve\xedculo",group:"DERMATO C"}],e={CAPSULA:{category:"CAPSULAS",confidence:.9},CAPS:{category:"CAPSULAS",confidence:.8},GASTRO:{category:"CAPSULAS GASTRO",confidence:.95},PRONTAS:{category:"CAPSULAS PRONTAS",confidence:.95},SACHE:{category:"SACHES",confidence:.95},MATERIA:{category:"MATERIA PRIMA",confidence:.9},PRIMA:{category:"MATERIA PRIMA",confidence:.8},GEL:{category:"GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL",confidence:.8},TRANSDERMICO:{category:"GEL TRANSDERMICO, GEL VAGINAL",confidence:.95},VAGINAL:{category:"GEL TRANSDERMICO, GEL VAGINAL",confidence:.95},COMESTIVEL:{category:"GEL COMESTIVEL",confidence:.95},CREME:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},LOCAO:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},LOÃ‡ÃƒO:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},POMADA:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},CAPILAR:{category:"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA",confidence:.9},SERUM:{category:"BASE SERUM",confidence:.95},SHOT:{category:"SHOT",confidence:.95},SOLUCAO:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.8},SOLUÃ‡ÃƒO:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.8},XAROPE:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.9},ESMALTE:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.9},SHAMPOO:{category:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",confidence:.85},SABONETE:{category:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",confidence:.85},CONDICIONADOR:{category:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",confidence:.9},LIQUID:{category:"LIQUID CAPS",confidence:.9},GOMA:{category:"GOMAS",confidence:.95},PASTILHA:{category:"PASTILHAS",confidence:.95},BOMBOM:{category:"BOMBOM",confidence:.95},FILME:{category:"FILMES",confidence:.8},OVULO:{category:"OVULOS",confidence:.95},Ã“VULO:{category:"OVULOS",confidence:.95},HOMEOPATIA:{category:"HOMEOPATIA, FLORAL E VEICULO",confidence:.9},FLORAL:{category:"HOMEOPATIA, FLORAL E VEICULO",confidence:.9},VEICULO:{category:"HOMEOPATIA, FLORAL E VEICULO",confidence:.8}};function f(a){return a.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function g(a,b){let c=f(a),d=f(b);if(c===d)return 1;if(0===c.length||0===d.length)return 0;if(c.includes(d)||d.includes(c))return .7;let e=c.split(" "),g=d.split(" "),h=e.filter(a=>g.includes(a));return h.length>0?.4+h.length/Math.max(e.length,g.length)*.3:0}class h{constructor(a={}){this.knownMappings=new Set,this.suggestions=new Map,this.updateKnownMappings(a)}updateKnownMappings(a){this.knownMappings.clear(),Object.keys(a).forEach(a=>this.knownMappings.add(f(a)))}isMapped(a){return this.knownMappings.has(f(a))}getSuggestions(a){let b=f(a);return this.suggestions.has(b)||this.suggestions.set(b,function(a){let b=[],c=f(a);for(let[a,d]of Object.entries(e))c.includes(a)&&b.push({category:d.category,confidence:d.confidence,reason:`Cont\xe9m palavra-chave: "${a}"`});for(let c of d){let d=g(a,c.label);d>.6&&b.push({category:c.value,confidence:.8*d,reason:`Similar a "${c.label}" (${Math.round(100*d)}%)`})}for(let c of d)for(let d of c.value.split(", ")){let e=g(a,d);e>.7&&b.push({category:c.value,confidence:.9*e,reason:`Corresponde a subcategoria: "${d}"`})}return b.reduce((a,b)=>{let c=a.find(a=>a.category===b.category);return!c||c.confidence<b.confidence?a.filter(a=>a.category!==b.category).concat(b):a},[]).sort((a,b)=>b.confidence-a.confidence).slice(0,3)}(a)),this.suggestions.get(b)||[]}hasUnmappedItems(a){return a.some(a=>!this.isMapped(a))}}},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44138:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>S,patchFetch:()=>R,routeModule:()=>N,serverHooks:()=>Q,workAsyncStorage:()=>O,workUnitAsyncStorage:()=>P});var d={};c.r(d),c.d(d,{POST:()=>M,dynamic:()=>A,maxDuration:()=>B});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(52963),w=c(66147),x=c(87),y=c(10806),z=c(22931);let A="force-dynamic",B=300,C=["7:00 AS 8:00","10:00 AS 13:00","14:00","15:00","16:00 AS 17:00","OUTROS"],D=[{title:"SOLIDOS",items:["CAPSULAS PRONTAS","CAPSULAS","CAPSULAS GASTRO","SACHES","MATERIA PRIMA"],hourlyLabel:"TOTAL POR HORARIO SOLIDOS",extras:["TOTAL SEM SEDEX (15:00)"],solids:!0},{title:"DERMATO A",items:["GEL TRANSDERMICO, GEL VAGINAL","CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA","BASE SERUM","SHOT","SOLU\xc7\xc3O, XAROPE, ESMALTE","SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR","LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA","GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL","GEL COMESTIVEL"],hourlyLabel:"TOTAL POR HORARIO DERMATO A."},{title:"DERMATO C",items:["LIQUID CAPS","CAPSULAS VAGINAIS","GOMAS","PASTILHAS","BOMBOM","FILMES","OVULOS","FILME VAGINAL","HOMEOPATIA, FLORAL E VEICULO"],hourlyLabel:"TOTAL POR HORARIO DERMATO C."}],E={CAPSULAS:"CAPSULAS","CAPSULAS GASTRO":"CAPSULAS GASTRO","CAPSULAS PRONTAS":"CAPSULAS PRONTAS",SACHES:"SACHES","MATERIA PRIMA":"MATERIA PRIMA","LOCAO CAPILAR":"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA","LOCAO CAPILAR N ALCOOLICA":"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA",HOMEOPATIA:"HOMEOPATIA, FLORAL E VEICULO",FLORAL:"HOMEOPATIA, FLORAL E VEICULO",VEICULO:"HOMEOPATIA, FLORAL E VEICULO","GEL TRANSDERMICO":"GEL TRANSDERMICO, GEL VAGINAL","GEL VAGINAL":"GEL TRANSDERMICO, GEL VAGINAL",CREME:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA","BASE SERUM":"BASE SERUM",SHOT:"SHOT",SOLUCAO:"SOLU\xc7\xc3O, XAROPE, ESMALTE",XAROPE:"SOLU\xc7\xc3O, XAROPE, ESMALTE",ESMALTE:"SOLU\xc7\xc3O, XAROPE, ESMALTE",SHAMPOO:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",SABONETE:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",CONDICIONADOR:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR","GEL COMESTIVEL":"GEL COMESTIVEL",GEL:"GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL","LIQUID CAPS":"LIQUID CAPS","CAPSULAS VAGINAIS":"CAPSULAS VAGINAIS",GOMAS:"GOMAS",PASTILHAS:"PASTILHAS",BOMBOM:"BOMBOM","FILME OROD.":"FILMES",OVULOS:"OVULOS","FILME VAGINAL":"FILME VAGINAL"},F=a=>(a||"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),G=a=>F(String(a||"").toLowerCase()),H=a=>F(String(a||"").toUpperCase().trim().replace(/\s+/g," ")),I=a=>{let b=(a=>{if(null==a)return null;if("number"==typeof a)return a>=0&&a<1?Math.floor(24*a):Math.floor(a);let b=String(a).trim(),c=b.match(/^(\d{1,2})(?::\d{1,2})?/);if(c)return parseInt(c[1],10);let d=Number(b.replace(",","."));return Number.isNaN(d)?null:d>=0&&d<1?Math.floor(24*d):Math.floor(d)})(a);return 8===b?C[0]:null!==b&&b>=10&&b<=13?C[1]:14===b?C[2]:15===b?C[3]:0===b||null!==b&&b>=16&&b<=23?C[4]:C[5]},J=(a,b)=>{let c=Object.keys(a||{}),d=c.map(a=>G(a));for(let a of b){let b=G(a),e=d.findIndex(a=>a.includes(b));if(e>=0)return c[e]}return null},K=a=>{if(null==a||""===a)return 0;if("number"==typeof a)return a;let b=String(a).trim().replace(/[^0-9.,-]/g,"");b.includes(",")&&b.includes(".")?b=b.replace(/\./g,"").replace(",","."):b.includes(",")&&!b.includes(".")&&(b=b.replace(",","."));let c=parseFloat(b);return Number.isFinite(c)?c:0},L=a=>{let b={};for(let[c,d]of Object.entries(a||{}))b[H(c)]=d;return b};async function M(a){try{let b,c=await (0,v.getServerSession)(w.N);if(!c?.user||!c.user.id)return u.NextResponse.json({error:"N\xe3o autorizado"},{status:401});if(!x.E2)return u.NextResponse.json({error:"Erro de configura\xe7\xe3o do servidor"},{status:500});let{data:d,error:e}=await x.E2.from("users").select("id").eq("id",c.user.id).single();if(e||!d)return u.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado no banco de dados"},{status:401});let f=await a.formData(),g=f.get("diario"),h=f.get("controle"),i=f.get("date"),j=(a=>{let[b,c]=a.split("/").map(Number),d=new Date(2024,c-1,b);return 0===d.getDay()&&d.setDate(d.getDate()+1),`${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`})(i);i!==j&&console.log(`ðŸ“… Data ajustada de domingo: ${i} â†’ ${j} (domingo â†’ segunda-feira)`);let k=f.get("mapping")||"{}",l="true"===f.get("checkOnly");if(!g||!h)return u.NextResponse.json({error:"Arquivos obrigat\xf3rios n\xe3o fornecidos"},{status:400});let m={};try{let a=k?JSON.parse(k):{};m=L({...E,...a})}catch(a){console.log("Invalid mapping JSON, using default mapping"),m=L(E)}let n=new z.Hv(m),o=await g.arrayBuffer(),p=y.LF(o),q=p.Sheets[p.SheetNames[0]],r=y.Wp.sheet_to_json(q),s=await h.arrayBuffer(),t=y.LF(s),A=t.Sheets[t.SheetNames[0]],B=y.Wp.sheet_to_json(A);if(!r.length||!B.length)return u.NextResponse.json({error:"Arquivos sem dados"},{status:400});let F=r.length,G=r[0]||{},M=B[0]||{},N=J(G,["forma","farmac","farmac\xeautica"])||Object.keys(G)[0],O=J(G,["receita","pedido","n\xfamero","numero"])||Object.keys(G)[1],P=J(G,["sq","seq"])||Object.keys(G)[2],Q=J(G,["vendedor","atendente","vend","respons\xe1vel","responsavel","usuario","colaborador"]),R=J(G,["valor","vlr","total","pre\xe7o","preco","r$","valor receita"]),S=J(G,["qtde","quantidade"]),T=J(M,["numero","n\xfamero","receita","pedido"])||Object.keys(M)[0],U=J(M,["seq","sq"])||Object.keys(M)[1],V=J(M,["hora","hor\xe1rio"])||Object.keys(M)[2],W=J(M,["linha","bancada"]);if(!N||!O||!P||!T||!U||!V)return u.NextResponse.json({error:"Colunas essenciais n\xe3o detectadas"},{status:400});let X={form:new Map,vend:new Map,val:new Map,qtde:new Map};for(let a of r){let b=`${H(a[O])}|${H(a[P])}`;X.form.set(b,H(a[N])),Q&&X.vend.set(b,String(a[Q]||"").trim()||"â€”"),R&&X.val.set(b,K(a[R])),S&&X.qtde.set(b,parseInt(a[S],10)||1)}let Y=new Set,Z=[];for(let a of B){let b=`${H(a[T])}|${H(a[U])}`;Y.has(b)||(Y.add(b),Z.push({formaNorm:X.form.get(b)||"",bucket:I(a[V]),vendedor:X.vend.get(b)||"â€”",valor:X.val.get(b)||0,quantidade:X.qtde.get(b)||1,linha:W?String(a[W]||""):null}))}let $=new Map,_=new Map,aa=0,ab=0,ac=0,ad=new Map,ae=Object.fromEntries(C.map(a=>[a,0])),af=new Set(D.find(a=>a.solids)?.items||[]);for(let a of Z){let b=m[a.formaNorm]||a.formaNorm||"(SEM MAPA)";if(!m[a.formaNorm]){let b=a.formaNorm||"(vazio)";_.set(b,(_.get(b)||0)+a.quantidade)}let c=`${b}|${a.bucket}`;$.set(c,($.get(c)||0)+a.quantidade),ae[a.bucket]=(ae[a.bucket]||0)+a.quantidade;let d=a.vendedor||"â€”",e=ad.get(d)||{qty:0,value:0};e.qty+=a.quantidade,e.value+=Number(a.valor||0),ad.set(d,e),af.has(b)&&"15:00"!==a.bucket&&(ac+=a.quantidade),aa+=a.quantidade,ab+=Number(a.valor||0)}let ag=[];for(let a of D){ag.push({kind:"section",label:a.title});let b=Object.fromEntries(C.map(a=>[a,0]));for(let c of a.items){let a={kind:"item",label:c},d=0;for(let e of C){let f=$.get(`${c}|${e}`)||0;a[e]=f,d+=f,b[e]+=f}a.total=d,ag.push(a)}let c={kind:"subtotalH",label:a.hourlyLabel},d=0;for(let a of C)c[a]=b[a],d+=b[a];if(c.total=d,ag.push(c),a.extras){for(let b of a.extras)if(/SEM\s*SEDEX\s*\(15:00\)/i.test(b)&&"SOLIDOS"===a.title){let a={kind:"extra",label:b},d=0;for(let b of C){let e="15:00"===b?0:c[b];a[b]=e,d+=e}a.total=d,ag.push(a)}}}let ah="â€”",ai=0;for(let[a,b]of ad.entries())b.value>ai&&(ai=b.value,ah=a);let aj={buckets:C.map(a=>({title:a,items:Array.from($.entries()).filter(([b])=>b.endsWith(`|${a}`)).map(([a,b])=>({title:a.split("|")[0],count:b})).sort((a,b)=>b.count-a.count).slice(0,12)}))};if(l){let a=Array.from(new Set(Z.map(a=>a.formaNorm)));if(!n.hasUnmappedItems(a))return console.log(`âš¡ Verifica\xe7\xe3o otimizada: todos os itens j\xe1 est\xe3o mapeados`),u.NextResponse.json({success:!0,checkOnly:!0,unmappedData:[]});let b=Array.from(_.entries()).map(([a,b])=>({forma:a,ocorrencias:b}));return console.log(`ðŸ” Verifica\xe7\xe3o de itens n\xe3o mapeados: encontrados ${b.length} itens`),u.NextResponse.json({success:!0,checkOnly:!0,unmappedData:b})}let ak={date:j,items:Z.map((a,b)=>({...a,id:b})),tableRows:ag,kpis:{totalQuantity:F,totalValue:ab,solidCount:ac,topSeller:ah,formulasProcessed:Z.length},sellersData:Array.from(ad.entries()).map(([a,b])=>({name:a,qty:b.qty,value:b.value,avg:b.qty?b.value/b.qty:0})).sort((a,b)=>b.value-a.value),kanbanData:aj,hourlyTotals:ae,unmappedData:Array.from(_.entries()).map(([a,b])=>({forma:a,ocorrencias:b}))};console.log("\uD83D\uDD04 Iniciando salvamento no banco de dados..."),console.log("\uD83D\uDCCA Dados do relat\xf3rio:",{userId:c.user.id,date:j,totalQuantity:F,totalValue:ab,solidCount:ac,topSeller:ah,mergedItemsCount:Z.length,totalQtySum:aa}),console.log("\uD83D\uDD0D Verificando relat\xf3rio existente para data:",j);let{data:al}=await x.E2.from("reports").select("*").eq("date",j).eq("user_id",c.user.id).maybeSingle();if(al){console.log("\uD83D\uDD04 Atualizando relat\xf3rio existente com ID:",al.id);let{data:a,error:c}=await x.E2.from("reports").update({title:`Relat\xf3rio ${j}`,status:"completed",diario_file_name:g.name,controle_file_name:h.name,total_quantity:F,total_value:ab,solid_count:ac,top_seller:ah,processed_data:ak,kanban_data:aj,sellers_data:ak.sellersData,updated_at:new Date().toISOString()}).eq("id",al.id).select("*").single();if(c||!a)throw console.error("âŒ Erro ao atualizar relat\xf3rio:",c),Error(`Erro ao atualizar relat\xf3rio: ${c?.message}`);b=a}else{console.log("\uD83C\uDD95 Criando novo relat\xf3rio para data:",j);let{data:a,error:d}=await x.E2.from("reports").insert({title:`Relat\xf3rio ${j}`,date:j,status:"completed",user_id:c.user.id,diario_file_name:g.name,controle_file_name:h.name,total_quantity:F,total_value:ab,solid_count:ac,top_seller:ah,processed_data:ak,kanban_data:aj,sellers_data:ak.sellersData}).select("*").single();if(d||!a)throw console.error("âŒ Erro ao criar relat\xf3rio:",d),Error(`Erro ao criar relat\xf3rio: ${d?.message}`);b=a}if(console.log("âœ… Relat\xf3rio processado com ID:",b.id),Z.length>0){if(console.log(`ðŸ”„ Processando ${Z.length} itens do relat\xf3rio...`),al){console.log("\uD83D\uDDD1ï¸  Removendo itens antigos do relat\xf3rio...");let{error:a}=await x.E2.from("report_items").delete().eq("report_id",b.id);if(a)throw console.error("âŒ Erro ao remover itens antigos:",a),Error(`Erro ao remover itens antigos: ${a.message}`);console.log("âœ… Itens antigos removidos")}let a=Z.map((a,c)=>({report_id:b.id,form_norm:a.formaNorm,linha:a.linha,horario:a.bucket,vendedor:a.vendedor,quantidade:Number(a.quantidade||1),valor:Number(a.valor||0),categoria:m[a.formaNorm]||a.formaNorm,source_file:"controle",row_index:c,is_mapped:!!m[a.formaNorm]}));console.log("\uD83D\uDCDD Exemplo de item a ser salvo:",a[0]);let{error:c}=await x.E2.from("report_items").insert(a);if(c)throw console.error("âŒ Erro ao salvar itens do relat\xf3rio:",c),Error(`Erro ao salvar itens do relat\xf3rio: ${c.message}`);console.log("âœ… Itens do relat\xf3rio salvos com sucesso")}console.log("\uD83D\uDD04 Atualizando \xfaltimo processamento...");let{data:am}=await x.E2.from("last_processing").select("id").eq("report_date",j).maybeSingle();console.log("\uD83D\uDD0D Registro existente encontrado:",!!am);let an={report_date:j,report_id:b.id,processed_at:new Date().toISOString(),total_quantity:F,total_value:ab,solid_count:ac,top_seller:ah,diario_file_name:g.name,controle_file_name:h.name,updated_at:new Date().toISOString()};console.log("\uD83D\uDCCB Dados do \xfaltimo processamento:",an);let ao=null;if(am){console.log("\uD83D\uDD04 Atualizando registro existente...");let{error:a}=await x.E2.from("last_processing").update(an).eq("report_date",j);ao=a}else{console.log("\uD83C\uDD95 Inserindo novo registro...");let{error:a}=await x.E2.from("last_processing").insert(an);ao=a}if(ao)throw console.error("âŒ Erro ao atualizar \xfaltimo processamento:",ao),Error(`Erro ao atualizar \xfaltimo processamento: ${ao.message}`);return console.log("âœ… \xdaltimo processamento atualizado com sucesso"),ak.reportId=b.id,console.log("\uD83C\uDF89 Todos os dados salvos com sucesso no banco!"),u.NextResponse.json(ak)}catch(a){return console.error("Error processing report:",a),u.NextResponse.json({error:"Erro no processamento dos arquivos: "+a.message},{status:500})}}let N=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/process-report/route",pathname:"/api/process-report",filename:"route",bundlePath:"app/api/process-report/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\Adrielsb\\Desktop\\FarmaGeniusProject\\app\\api\\process-report\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:O,workUnitAsyncStorage:P,serverHooks:Q}=N;function R(){return(0,g.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:P})}async function S(a,b,c){var d;let e="/api/process-report/route";"/index"===e&&(e="/");let g=await N.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||N.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===N.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),L={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>N.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},M=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(M,(0,l.signalFromNodeResponse)(b));try{let d=async c=>N.handle(P,L).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=L.renderOpts.collectedTags;if(!E)return await (0,o.I)(M,O,e,L.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,d=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await N.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await N.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(M,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(K||b instanceof s.NoFallbackError||await N.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(M,O,new Response(null,{status:500})),null}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66147:(a,b,c)=>{"use strict";c.d(b,{N:()=>g});var d=c(28120),e=c(87082),f=c(87);let g={providers:[(0,d.A)({id:"credentials",name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a,b){if(console.log("\uD83D\uDD10 NextAuth authorize called:",{email:a?.email}),!a?.email||!a?.password)return console.log("âŒ Missing credentials"),null;if(!f.E2)return console.log("âŒ Supabase admin client not available"),null;try{let{data:b,error:c}=await f.E2.from("users").select("id, name, email, password").eq("email",a.email).single();if(c)return console.log("âŒ Supabase error:",c.message),null;if(!b)return console.log("âŒ User not found"),null;if(!b||!b.password)return console.log("âŒ User has no password set"),null;if(!await (0,e.compare)(a.password,b.password))return console.log("âŒ Invalid password for user:",a.email),null;return console.log("âœ… Authentication successful for:",a.email),{id:b.id,email:b.email,name:b.name}}catch(a){return console.error("âŒ Auth error:",a),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:a,user:b})=>(b&&(a.id=b.id,a.email=b.email,a.name=b.name),a),session:async({session:a,token:b})=>(b&&(a.user.id=b.id,a.user.email=b.email,a.user.name=b.name),a)},pages:{signIn:"/auth/login"},debug:!1}},74075:a=>{"use strict";a.exports=require("zlib")},78335:()=>{},79428:a=>{"use strict";a.exports=require("buffer")},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{"use strict";a.exports=require("events")},96487:()=>{}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4996,2461,1692,7082,8858,806],()=>b(b.s=44138));module.exports=c})();