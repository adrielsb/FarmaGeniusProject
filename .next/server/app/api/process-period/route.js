(()=>{var a={};a.id=8869,a.ids=[8869],a.modules={87:(a,b,c)=>{"use strict";c.d(b,{E2:()=>g,Vt:()=>h});var d=c(82461);let e="https://yhtnlxnntpipnshtivqx.supabase.co",f=process.env.SUPABASE_SERVICE_ROLE_KEY;(0,d.UU)(e,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlodG5seG5udHBpcG5zaHRpdnF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMzQxNDksImV4cCI6MjA3MTkxMDE0OX0.MdE9PWSWFFLMcudTw40lehT2HXiG-S6S4gfWfod0mVM",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0},db:{schema:"public"},global:{headers:{"x-my-custom-header":"FarmaGenius"}}});let g=f?(0,d.UU)(e,f,{auth:{autoRefreshToken:!1,persistSession:!1},db:{schema:"public"}}):null;function h(){return{url:e,hasServiceRole:!!f,projectId:e.match(/https:\/\/([^.]+)\./)?.[1]||"unknown"}}},261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:a=>{"use strict";a.exports=require("querystring")},11997:a=>{"use strict";a.exports=require("punycode")},12412:a=>{"use strict";a.exports=require("assert")},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},22931:(a,b,c)=>{"use strict";c.d(b,{Hv:()=>h});let d=[{value:"CAPSULAS PRONTAS",label:"C\xe1psulas Prontas",group:"S\xd3LIDOS"},{value:"CAPSULAS",label:"C\xe1psulas",group:"S\xd3LIDOS"},{value:"CAPSULAS GASTRO",label:"C\xe1psulas Gastro",group:"S\xd3LIDOS"},{value:"SACHES",label:"Sach\xeas",group:"S\xd3LIDOS"},{value:"MATERIA PRIMA",label:"Mat\xe9ria Prima",group:"S\xd3LIDOS"},{value:"GEL TRANSDERMICO, GEL VAGINAL",label:"Gel Transd\xe9rmico/Vaginal",group:"DERMATO A"},{value:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",label:"Cremes e Lo\xe7\xf5es",group:"DERMATO A"},{value:"BASE SERUM",label:"Base Serum",group:"DERMATO A"},{value:"SHOT",label:"Shot",group:"DERMATO A"},{value:"SOLU\xc7\xc3O, XAROPE, ESMALTE",label:"Solu\xe7\xe3o/Xarope/Esmalte",group:"DERMATO A"},{value:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",label:"Produtos Capilares",group:"DERMATO A"},{value:"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA",label:"Lo\xe7\xe3o Capilar",group:"DERMATO A"},{value:"GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL",label:"G\xe9is Diversos",group:"DERMATO A"},{value:"GEL COMESTIVEL",label:"Gel Comest\xedvel",group:"DERMATO A"},{value:"LIQUID CAPS",label:"Liquid Caps",group:"DERMATO C"},{value:"CAPSULAS VAGINAIS",label:"C\xe1psulas Vaginais",group:"DERMATO C"},{value:"GOMAS",label:"Gomas",group:"DERMATO C"},{value:"PASTILHAS",label:"Pastilhas",group:"DERMATO C"},{value:"BOMBOM",label:"Bombom",group:"DERMATO C"},{value:"FILMES",label:"Filmes",group:"DERMATO C"},{value:"OVULOS",label:"\xd3vulos",group:"DERMATO C"},{value:"FILME VAGINAL",label:"Filme Vaginal",group:"DERMATO C"},{value:"HOMEOPATIA, FLORAL E VEICULO",label:"Homeopatia/Floral/Ve\xedculo",group:"DERMATO C"}],e={CAPSULA:{category:"CAPSULAS",confidence:.9},CAPS:{category:"CAPSULAS",confidence:.8},GASTRO:{category:"CAPSULAS GASTRO",confidence:.95},PRONTAS:{category:"CAPSULAS PRONTAS",confidence:.95},SACHE:{category:"SACHES",confidence:.95},MATERIA:{category:"MATERIA PRIMA",confidence:.9},PRIMA:{category:"MATERIA PRIMA",confidence:.8},GEL:{category:"GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL",confidence:.8},TRANSDERMICO:{category:"GEL TRANSDERMICO, GEL VAGINAL",confidence:.95},VAGINAL:{category:"GEL TRANSDERMICO, GEL VAGINAL",confidence:.95},COMESTIVEL:{category:"GEL COMESTIVEL",confidence:.95},CREME:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},LOCAO:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},LOÇÃO:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},POMADA:{category:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA",confidence:.85},CAPILAR:{category:"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA",confidence:.9},SERUM:{category:"BASE SERUM",confidence:.95},SHOT:{category:"SHOT",confidence:.95},SOLUCAO:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.8},SOLUÇÃO:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.8},XAROPE:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.9},ESMALTE:{category:"SOLU\xc7\xc3O, XAROPE, ESMALTE",confidence:.9},SHAMPOO:{category:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",confidence:.85},SABONETE:{category:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",confidence:.85},CONDICIONADOR:{category:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",confidence:.9},LIQUID:{category:"LIQUID CAPS",confidence:.9},GOMA:{category:"GOMAS",confidence:.95},PASTILHA:{category:"PASTILHAS",confidence:.95},BOMBOM:{category:"BOMBOM",confidence:.95},FILME:{category:"FILMES",confidence:.8},OVULO:{category:"OVULOS",confidence:.95},ÓVULO:{category:"OVULOS",confidence:.95},HOMEOPATIA:{category:"HOMEOPATIA, FLORAL E VEICULO",confidence:.9},FLORAL:{category:"HOMEOPATIA, FLORAL E VEICULO",confidence:.9},VEICULO:{category:"HOMEOPATIA, FLORAL E VEICULO",confidence:.8}};function f(a){return a.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}function g(a,b){let c=f(a),d=f(b);if(c===d)return 1;if(0===c.length||0===d.length)return 0;if(c.includes(d)||d.includes(c))return .7;let e=c.split(" "),g=d.split(" "),h=e.filter(a=>g.includes(a));return h.length>0?.4+h.length/Math.max(e.length,g.length)*.3:0}class h{constructor(a={}){this.knownMappings=new Set,this.suggestions=new Map,this.updateKnownMappings(a)}updateKnownMappings(a){this.knownMappings.clear(),Object.keys(a).forEach(a=>this.knownMappings.add(f(a)))}isMapped(a){return this.knownMappings.has(f(a))}getSuggestions(a){let b=f(a);return this.suggestions.has(b)||this.suggestions.set(b,function(a){let b=[],c=f(a);for(let[a,d]of Object.entries(e))c.includes(a)&&b.push({category:d.category,confidence:d.confidence,reason:`Cont\xe9m palavra-chave: "${a}"`});for(let c of d){let d=g(a,c.label);d>.6&&b.push({category:c.value,confidence:.8*d,reason:`Similar a "${c.label}" (${Math.round(100*d)}%)`})}for(let c of d)for(let d of c.value.split(", ")){let e=g(a,d);e>.7&&b.push({category:c.value,confidence:.9*e,reason:`Corresponde a subcategoria: "${d}"`})}return b.reduce((a,b)=>{let c=a.find(a=>a.category===b.category);return!c||c.confidence<b.confidence?a.filter(a=>a.category!==b.category).concat(b):a},[]).sort((a,b)=>b.confidence-a.confidence).slice(0,3)}(a)),this.suggestions.get(b)||[]}hasUnmappedItems(a){return a.some(a=>!this.isMapped(a))}}},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},42015:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>Y,patchFetch:()=>X,routeModule:()=>T,serverHooks:()=>W,workAsyncStorage:()=>U,workUnitAsyncStorage:()=>V});var d={};c.r(d),c.d(d,{POST:()=>S,dynamic:()=>A,maxDuration:()=>B});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(52963),w=c(66147),x=c(87),y=c(10806),z=c(22931);let A="force-dynamic",B=300,C=["7:00 AS 8:00","10:00 AS 13:00","14:00","15:00","16:00 AS 17:00","OUTROS"],D=[{title:"SOLIDOS",items:["CAPSULAS PRONTAS","CAPSULAS","CAPSULAS GASTRO","SACHES","MATERIA PRIMA"],hourlyLabel:"TOTAL POR HORARIO SOLIDOS",extras:["TOTAL SEM SEDEX (15:00)"],solids:!0},{title:"DERMATO A",items:["GEL TRANSDERMICO, GEL VAGINAL","CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA","BASE SERUM","SHOT","SOLU\xc7\xc3O, XAROPE, ESMALTE","SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR","LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA","GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL","GEL COMESTIVEL"],hourlyLabel:"TOTAL POR HORARIO DERMATO A."},{title:"DERMATO C",items:["LIQUID CAPS","CAPSULAS VAGINAIS","GOMAS","PASTILHAS","BOMBOM","FILMES","OVULOS","FILME VAGINAL","HOMEOPATIA, FLORAL E VEICULO"],hourlyLabel:"TOTAL POR HORARIO DERMATO C."}],E={CAPSULAS:"CAPSULAS","CAPSULAS GASTRO":"CAPSULAS GASTRO","CAPSULAS PRONTAS":"CAPSULAS PRONTAS",SACHES:"SACHES","MATERIA PRIMA":"MATERIA PRIMA","LOCAO CAPILAR":"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA","LOCAO CAPILAR N ALCOOLICA":"LO\xc7\xc3O CAPILAR, LO\xc7\xc3O CAPILAR \xd1 ALCOOLICA",HOMEOPATIA:"HOMEOPATIA, FLORAL E VEICULO",FLORAL:"HOMEOPATIA, FLORAL E VEICULO",VEICULO:"HOMEOPATIA, FLORAL E VEICULO","GEL TRANSDERMICO":"GEL TRANSDERMICO, GEL VAGINAL","GEL VAGINAL":"GEL TRANSDERMICO, GEL VAGINAL",CREME:"CREME, HYDRA FRESH, SECOND SKIN, CREME CRODA, CREME N\xc3O IONICO, CREME OIL FREE, CREME AREA DOS OLHOS, CREME CELULITE, LO\xc7\xc3O, LO\xc7\xc3O CREMOSA, LO\xc7\xc3O CRODA, LO\xc7\xc3O N\xc3O IONICA, LO\xc7\xc3O OIL FREE, POMADA","BASE SERUM":"BASE SERUM",SHOT:"SHOT",SOLUCAO:"SOLU\xc7\xc3O, XAROPE, ESMALTE",XAROPE:"SOLU\xc7\xc3O, XAROPE, ESMALTE",ESMALTE:"SOLU\xc7\xc3O, XAROPE, ESMALTE",SHAMPOO:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",SABONETE:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR",CONDICIONADOR:"SHAMPOO, SABONETE, SABONETE CREMOSO, CONDICIONADOR","GEL COMESTIVEL":"GEL COMESTIVEL",GEL:"GEL , GEL ACQUAGEL, GEL ALCOOLICO, GEL CREME, GEL DE AMIGEL, GEL FLUIDO, GEL NATROSOL, GEL SEPIGEL","LIQUID CAPS":"LIQUID CAPS","CAPSULAS VAGINAIS":"CAPSULAS VAGINAIS",GOMAS:"GOMAS",PASTILHAS:"PASTILHAS",BOMBOM:"BOMBOM","FILME OROD.":"FILMES",OVULOS:"OVULOS","FILME VAGINAL":"FILME VAGINAL"},F=a=>(a||"").normalize("NFD").replace(/[\u0300-\u036f]/g,""),G=a=>F(String(a||"").toLowerCase()),H=a=>F(String(a||"").toUpperCase().trim().replace(/\s+/g," ")),I=a=>{let b=(a=>{if(null==a)return null;if("number"==typeof a)return a>=0&&a<1?Math.floor(24*a):Math.floor(a);let b=String(a).trim(),c=b.match(/^(\d{1,2})(?::\d{1,2})?/);if(c)return parseInt(c[1],10);let d=Number(b.replace(",","."));return Number.isNaN(d)?null:d>=0&&d<1?Math.floor(24*d):Math.floor(d)})(a);return 8===b?C[0]:null!==b&&b>=10&&b<=13?C[1]:14===b?C[2]:15===b?C[3]:0===b||null!==b&&b>=16&&b<=23?C[4]:C[5]},J=(a,b)=>{let c=Object.keys(a||{}),d=c.map(a=>G(a));for(let a of b){let b=G(a),e=d.findIndex(a=>a.includes(b));if(e>=0)return c[e]}return null},K=a=>{if(null==a||""===a)return 0;if("number"==typeof a)return a;let b=String(a).trim().replace(/[^0-9.,-]/g,"");b.includes(",")&&b.includes(".")?b=b.replace(/\./g,"").replace(",","."):b.includes(",")&&!b.includes(".")&&(b=b.replace(",","."));let c=parseFloat(b);return Number.isFinite(c)?c:0},L=a=>{let b={};for(let[c,d]of Object.entries(a||{}))b[H(c)]=d;return b},M=new Set,N=a=>{let[b,c]=a.split("/").map(Number),d=new Date(2024,c-1,b);0===d.getDay()&&d.setDate(d.getDate()+1);let e=`${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`;return a===e||M.has(a)||(M.add(a),console.log(`📅 Data de entrega ajustada: ${a} → ${e} (domingo → segunda-feira)`)),e},O=a=>{for(let[b,c]of Object.entries(a))if(c){if("number"==typeof c&&c>4e4&&c<5e4){let a=new Date(new Date(1900,0,1).getTime()+(c-2)*864e5);return N(`${String(a.getDate()).padStart(2,"0")}/${String(a.getMonth()+1).padStart(2,"0")}`)}if("string"==typeof c){for(let a of[/(\d{1,2})\/(\d{1,2})(?:\/\d{2,4})?/,/(\d{1,2})-(\d{1,2})(?:-\d{2,4})?/,/(\d{4})-(\d{1,2})-(\d{1,2})/]){let b=c.match(a);if(b)return N(b[3]?`${b[3].padStart(2,"0")}/${b[2].padStart(2,"0")}`:`${b[1].padStart(2,"0")}/${b[2].padStart(2,"0")}`)}let a=/(\d{1,2})[\/\-\s](\d{1,2}|\w{3})[\/\-\s](\d{2,4})/i,b=c.match(a);if(b){let a={jan:"01",fev:"02",mar:"03",abr:"04",mai:"05",jun:"06",jul:"07",ago:"08",set:"09",out:"10",nov:"11",dez:"12"},c=b[2];return isNaN(parseInt(c))&&(c=a[c.toLowerCase()]||"01"),N(`${b[1].padStart(2,"0")}/${c.padStart(2,"0")}`)}}if(c instanceof Date)return N(`${String(c.getDate()).padStart(2,"0")}/${String(c.getMonth()+1).padStart(2,"0")}`)}return null};async function P(a,b,c,d){let e=a[0]||{},f=b[0]||{},g=J(e,["forma","farmac","farmac\xeautica"])||Object.keys(e)[0],h=J(e,["receita","pedido","n\xfamero","numero"])||Object.keys(e)[1],i=J(e,["sq","seq"])||Object.keys(e)[2],j=J(e,["qtde","quantidade"]),k=J(f,["numero","n\xfamero","receita","pedido"])||Object.keys(f)[0],l=J(f,["seq","sq"])||Object.keys(f)[1],m=J(f,["hora","hor\xe1rio"])||Object.keys(f)[2];if(!g||!h||!i||!k||!l||!m)throw Error(`Colunas essenciais n\xe3o detectadas para ${d}`);let n={form:new Map,qtde:new Map};for(let b of a){let a=`${H(b[h])}|${H(b[i])}`;n.form.set(a,H(b[g])),j&&n.qtde.set(a,parseInt(b[j],10)||1)}let o=new Set,p=[];for(let a of b){let b=`${H(a[k])}|${H(a[l])}`;o.has(b)||(o.add(b),p.push({formaNorm:n.form.get(b)||"",quantidade:n.qtde.get(b)||1}))}let q=new Map;for(let a of p)if(!c[a.formaNorm]){let b=a.formaNorm||"(vazio)";q.set(b,(q.get(b)||0)+a.quantidade)}return Array.from(q.entries()).map(([a,b])=>({forma:a,ocorrencias:b}))}async function Q(a,b,c,d,e=!1,f){M.clear(),console.log("\uD83D\uDCC5 Detectando datas nos arquivos..."),console.log("\uD83D\uDCDD Exemplo de registro do di\xe1rio:",JSON.stringify(a[0],null,2)),console.log("\uD83D\uDCDD Exemplo de registro do controle:",JSON.stringify(b[0],null,2));let g=new Set;if(a.forEach((a,b)=>{let c=O(a);c&&(g.add(c),b<5&&console.log(`📅 Data encontrada no di\xe1rio linha ${b}: ${c}`))}),b.forEach((a,b)=>{let c=O(a);c&&(g.add(c),b<5&&console.log(`📅 Data encontrada no controle linha ${b}: ${c}`))}),console.log("\uD83D\uDCC5 Datas encontradas:",Array.from(g)),0===g.size)throw Error("Nenhuma data foi encontrada nos arquivos. Verifique se os arquivos cont\xeam campos de data v\xe1lidos.");let h=[],i=new Map,j=Array.from(g);console.log(`🚀 Iniciando processamento de ${j.length} datas usando processamento paralelo...`);let k=async f=>{console.log(`🔄 ${e?"Verificando":"Processando"} data: ${f}`);let g=a.filter(a=>O(a)===f),h=b.filter(a=>O(a)===f);if(0===g.length||0===h.length)return console.log(`⚠️ Dados insuficientes para ${f}, pulando...`),{date:f,report:null,unmappedData:[]};if(e){let a=await P(g,h,c,f);return{date:f,report:null,unmappedData:a}}{let{report:a,unmappedData:b}=await R(g,h,c,f,d);return{date:f,report:a,unmappedData:b}}},l=[];for(let a=0;a<j.length;a+=3){let b=j.slice(a,a+3);console.log(`📦 Processando lote ${Math.floor(a/3)+1}/${Math.ceil(j.length/3)} com ${b.length} datas: ${b.join(", ")}`);let c=await Promise.all(b.map(k));l.push(...c),a+3<j.length&&await new Promise(a=>setTimeout(a,100))}for(let{report:a,unmappedData:b}of l)for(let c of(a&&h.push(a),b)){let a=i.get(c.forma)||0;i.set(c.forma,a+c.ocorrencias)}return console.log(`✅ Processamento paralelo conclu\xeddo! ${h.length} relat\xf3rios processados`),{processedReports:h,aggregatedUnmappedData:Array.from(i.entries()).map(([a,b])=>({forma:a,ocorrencias:b}))}}async function R(a,b,c,d,e){let f,g=a.length,h=a[0]||{},i=b[0]||{},j=J(h,["forma","farmac","farmac\xeautica"])||Object.keys(h)[0],k=J(h,["receita","pedido","n\xfamero","numero"])||Object.keys(h)[1],l=J(h,["sq","seq"])||Object.keys(h)[2],m=J(h,["vendedor","atendente","vend","respons\xe1vel","responsavel","usuario","colaborador"]),n=J(h,["valor","vlr","total","pre\xe7o","preco","r$","valor receita"]),o=J(h,["qtde","quantidade"]),p=J(i,["numero","n\xfamero","receita","pedido"])||Object.keys(i)[0],q=J(i,["seq","sq"])||Object.keys(i)[1],r=J(i,["hora","hor\xe1rio"])||Object.keys(i)[2],s=J(i,["linha","bancada"]);if(!j||!k||!l||!p||!q||!r)throw Error(`Colunas essenciais n\xe3o detectadas para ${d}`);let t={form:new Map,vend:new Map,val:new Map,qtde:new Map};for(let b of a){let a=`${H(b[k])}|${H(b[l])}`;t.form.set(a,H(b[j])),m&&t.vend.set(a,String(b[m]||"").trim()||"—"),n&&t.val.set(a,K(b[n])),o&&t.qtde.set(a,parseInt(b[o],10)||1)}let u=new Set,v=[];for(let a of b){let b=`${H(a[p])}|${H(a[q])}`;u.has(b)||(u.add(b),v.push({formaNorm:t.form.get(b)||"",bucket:I(a[r]),vendedor:t.vend.get(b)||"—",valor:t.val.get(b)||0,quantidade:t.qtde.get(b)||1,linha:s?String(a[s]||""):null}))}let w=new Map,y=new Map,z=0,A=0,B=new Map,E=Object.fromEntries(C.map(a=>[a,0])),F=new Set(D.find(a=>a.solids)?.items||[]);for(let a of v){let b=c[a.formaNorm]||a.formaNorm||"(SEM MAPA)";if(!c[a.formaNorm]){let b=a.formaNorm||"(vazio)";y.set(b,(y.get(b)||0)+a.quantidade)}let d=`${b}|${a.bucket}`;w.set(d,(w.get(d)||0)+a.quantidade),E[a.bucket]=(E[a.bucket]||0)+a.quantidade;let e=a.vendedor||"—",f=B.get(e)||{qty:0,value:0};f.qty+=a.quantidade,f.value+=Number(a.valor||0),B.set(e,f),F.has(b)&&"15:00"!==a.bucket&&(A+=a.quantidade),a.quantidade,z+=Number(a.valor||0)}let G=[];for(let a of D){G.push({kind:"section",label:a.title});let b=Object.fromEntries(C.map(a=>[a,0]));for(let c of a.items){let a={kind:"item",label:c},d=0;for(let e of C){let f=w.get(`${c}|${e}`)||0;a[e]=f,d+=f,b[e]+=f}a.total=d,G.push(a)}let c={kind:"subtotalH",label:a.hourlyLabel},d=0;for(let a of C)c[a]=b[a],d+=b[a];if(c.total=d,G.push(c),a.extras){for(let b of a.extras)if(/SEM\s*SEDEX\s*\(15:00\)/i.test(b)&&"SOLIDOS"===a.title){let a={kind:"extra",label:b},d=0;for(let b of C){let e="15:00"===b?0:c[b];a[b]=e,d+=e}a.total=d,G.push(a)}}}let L="—",M=0;for(let[a,b]of B.entries())b.value>M&&(M=b.value,L=a);let N={buckets:C.map(a=>({title:a,items:Array.from(w.entries()).filter(([b])=>b.endsWith(`|${a}`)).map(([a,b])=>({title:a.split("|")[0],count:b})).sort((a,b)=>b.count-a.count).slice(0,12)}))},O={date:d,items:v.map((a,b)=>({...a,id:b})),tableRows:G,kpis:{totalQuantity:g,totalValue:z,solidCount:A,topSeller:L,formulasProcessed:g},sellersData:Array.from(B.entries()).map(([a,b])=>({name:a,qty:b.qty,value:b.value,avg:b.qty?b.value/b.qty:0})).sort((a,b)=>b.value-a.value),kanbanData:N,hourlyTotals:E,unmappedData:Array.from(y.entries()).map(([a,b])=>({forma:a,ocorrencias:b}))};if(console.log(`💾 Salvando relat\xf3rio para ${d}...`),!x.E2)throw Error("Supabase admin client not initialized");let{data:P}=await x.E2.from("reports").select("*").eq("date",d).eq("user_id",e).maybeSingle();if(P){console.log(`🔄 Atualizando relat\xf3rio existente para ${d} com ID:`,P.id);let{data:a,error:b}=await x.E2.from("reports").update({title:`Relat\xf3rio ${d}`,status:"completed",diario_file_name:"Per\xedodo - Di\xe1rio de Receitas",controle_file_name:"Per\xedodo - Controle de F\xf3rmulas",total_quantity:g,total_value:z,solid_count:A,top_seller:L,processed_data:O,kanban_data:N,sellers_data:O.sellersData,updated_at:new Date().toISOString()}).eq("id",P.id).select("*").single();if(b||!a)throw Error(`Erro ao atualizar relat\xf3rio para ${d}: ${b?.message}`);f=a}else{let{data:a,error:b}=await x.E2.from("reports").insert({title:`Relat\xf3rio ${d}`,date:d,status:"completed",user_id:e,diario_file_name:"Per\xedodo - Di\xe1rio de Receitas",controle_file_name:"Per\xedodo - Controle de F\xf3rmulas",total_quantity:g,total_value:z,solid_count:A,top_seller:L,processed_data:O,kanban_data:N,sellers_data:O.sellersData}).select("*").single();if(b||!a)throw Error(`Erro ao criar relat\xf3rio para ${d}: ${b?.message}`);f=a}if(v.length>0){P&&await x.E2.from("report_items").delete().eq("report_id",f.id);let a=v.map((a,b)=>({report_id:f.id,form_norm:a.formaNorm,linha:a.linha,horario:a.bucket,vendedor:a.vendedor,quantidade:Number(a.quantidade||1),valor:Number(a.valor||0),categoria:c[a.formaNorm]||a.formaNorm,source_file:"controle",row_index:b,is_mapped:!!c[a.formaNorm]})),{error:b}=await x.E2.from("report_items").insert(a);if(b)throw Error(`Erro ao salvar itens do relat\xf3rio para ${d}: ${b.message}`)}let{data:Q}=await x.E2.from("last_processing").select("id").eq("report_date",d).maybeSingle(),R={report_date:d,report_id:f.id,processed_at:new Date().toISOString(),total_quantity:g,total_value:z,solid_count:A,top_seller:L,diario_file_name:"Per\xedodo - Di\xe1rio de Receitas",controle_file_name:"Per\xedodo - Controle de F\xf3rmulas",updated_at:new Date().toISOString()};return Q?await x.E2.from("last_processing").update(R).eq("report_date",d):await x.E2.from("last_processing").insert(R),{report:{date:d,reportId:f.id,summary:O.kpis},unmappedData:Array.from(y.entries()).map(([a,b])=>({forma:a,ocorrencias:b}))}}async function S(a){try{let b=await (0,v.getServerSession)(w.N);if(!b?.user||!b.user.id)return u.NextResponse.json({error:"N\xe3o autorizado"},{status:401});if(!x.E2)return u.NextResponse.json({error:"Erro de configura\xe7\xe3o do servidor"},{status:500});let{data:c,error:d}=await x.E2.from("users").select("id").eq("id",b.user.id).single();if(d||!c)return u.NextResponse.json({error:"Usu\xe1rio n\xe3o encontrado no banco de dados"},{status:401});let e=await a.formData(),f=e.get("diario"),g=e.get("controle"),h=e.get("mapping")||"{}",i="true"===e.get("checkOnly");if(!f||!g)return u.NextResponse.json({error:"Arquivos obrigat\xf3rios n\xe3o fornecidos"},{status:400});let j={};try{let a=h?JSON.parse(h):{};j=L({...E,...a})}catch(a){console.log("Invalid mapping JSON, using default mapping"),j=L(E)}let k=new z.Hv(j),l=await f.arrayBuffer(),m=y.LF(l),n=m.Sheets[m.SheetNames[0]],o=y.Wp.sheet_to_json(n),p=await g.arrayBuffer(),q=y.LF(p),r=q.Sheets[q.SheetNames[0]],s=y.Wp.sheet_to_json(r);if(!o.length||!s.length)return u.NextResponse.json({error:"Arquivos sem dados"},{status:400});console.log("\uD83D\uDE80 Iniciando processamento por per\xedodo..."),console.log(`📊 Dados carregados: ${o.length} linhas do di\xe1rio, ${s.length} linhas do controle`);let{processedReports:t,aggregatedUnmappedData:A}=await Q(o,s,j,b.user.id,i,k);if(i)return console.log(`🔍 Verifica\xe7\xe3o conclu\xedda! ${A.length} itens n\xe3o mapeados encontrados`),u.NextResponse.json({success:!0,checkOnly:!0,unmappedData:A});return console.log(`✅ Processamento conclu\xeddo! ${t.length} relat\xf3rios criados/atualizados`),u.NextResponse.json({success:!0,message:`${t.length} relat\xf3rios processados com sucesso`,processedReports:t,unmappedData:A})}catch(a){return console.error("Error processing period:",a),u.NextResponse.json({error:"Erro no processamento dos arquivos por per\xedodo: "+a.message},{status:500})}}let T=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/process-period/route",pathname:"/api/process-period",filename:"route",bundlePath:"app/api/process-period/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\Adrielsb\\Desktop\\FarmaGeniusProject\\app\\api\\process-period\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:U,workUnitAsyncStorage:V,serverHooks:W}=T;function X(){return(0,g.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:V})}async function Y(a,b,c){var d;let e="/api/process-period/route";"/index"===e&&(e="/");let g=await T.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,resolvedPathname:C}=g,D=(0,j.normalizeAppPath)(e),E=!!(y.dynamicRoutes[D]||y.routes[C]);if(E&&!x){let a=!!y.routes[C],b=y.dynamicRoutes[D];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let F=null;!E||T.isDev||x||(F="/index"===(F=C)?"/":F);let G=!0===T.isDev||!E,H=E&&!G,I=a.method||"GET",J=(0,i.getTracer)(),K=J.getActiveScopeSpan(),L={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:G,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:H,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>T.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},M=new k.NodeNextRequest(a),N=new k.NodeNextResponse(b),O=l.NextRequestAdapter.fromNodeNextRequest(M,(0,l.signalFromNodeResponse)(b));try{let d=async c=>T.handle(O,L).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=J.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${I} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${I} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&B&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=L.renderOpts.collectedTags;if(!E)return await (0,o.I)(M,N,e,L.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,d=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await T.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})},z),b}},l=await T.handleResponse({req:a,nextConfig:w,cacheKey:F,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:B,responseGenerator:k,waitUntil:c.waitUntil});if(!E)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&E||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(M,N,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};K?await g(K):await J.withPropagatedContext(a.headers,()=>J.trace(m.BaseServerSpan.handleRequest,{spanName:`${I} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":I,"http.target":a.url}},g))}catch(b){if(K||b instanceof s.NoFallbackError||await T.onRequestError(a,b,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:H,isOnDemandRevalidate:A})}),E)throw b;return await (0,o.I)(M,N,new Response(null,{status:500})),null}}},44870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{"use strict";a.exports=require("crypto")},55591:a=>{"use strict";a.exports=require("https")},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66147:(a,b,c)=>{"use strict";c.d(b,{N:()=>g});var d=c(28120),e=c(87082),f=c(87);let g={providers:[(0,d.A)({id:"credentials",name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(a,b){if(console.log("\uD83D\uDD10 NextAuth authorize called:",{email:a?.email}),!a?.email||!a?.password)return console.log("❌ Missing credentials"),null;if(!f.E2)return console.log("❌ Supabase admin client not available"),null;try{let{data:b,error:c}=await f.E2.from("users").select("id, name, email, password").eq("email",a.email).single();if(c)return console.log("❌ Supabase error:",c.message),null;if(!b)return console.log("❌ User not found"),null;if(!b||!b.password)return console.log("❌ User has no password set"),null;if(!await (0,e.compare)(a.password,b.password))return console.log("❌ Invalid password for user:",a.email),null;return console.log("✅ Authentication successful for:",a.email),{id:b.id,email:b.email,name:b.name}}catch(a){return console.error("❌ Auth error:",a),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:a,user:b})=>(b&&(a.id=b.id,a.email=b.email,a.name=b.name),a),session:async({session:a,token:b})=>(b&&(a.user.id=b.id,a.user.email=b.email,a.user.name=b.name),a)},pages:{signIn:"/auth/login"},debug:!1}},74075:a=>{"use strict";a.exports=require("zlib")},78335:()=>{},79428:a=>{"use strict";a.exports=require("buffer")},79551:a=>{"use strict";a.exports=require("url")},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},94735:a=>{"use strict";a.exports=require("events")},96487:()=>{}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4996,2461,1692,7082,8858,806],()=>b(b.s=42015));module.exports=c})();